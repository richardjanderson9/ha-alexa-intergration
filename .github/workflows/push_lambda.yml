## Made with ‚ù§Ô∏è by Richard | With assistance from Co-pilot.
## Description: GitHub Actions workflow to deploy an AWS Lambda function on push to the main branch. It checks for required secrets, validates AWS credentials, prepares a deployment package, and updates the Lambda function code.

name: Deploy Lambda on push

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ## AWS Environment Information
      AWS_REGION: ${{ secrets.AWS_REGION }}
      LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
      ## AWS IAM: Identification and Authentication.
      AWS_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      ## Python Dependencies: List of Python packages required for the Lambda function, separated by commas.
      Python_Dependences: ${{ secrets.PYTHON_DEPENDENCES }}
      ## Home Assistant: Authentication and Access Information.
      HA_Token_1: ${{ secrets.HA_LONGLIFETOKEN_1 }}
      HA_Token_2: ${{ secrets.HA_LONGLIFETOKEN_2 }}
      HA_URL: ${{ secrets.HA_ACCESSDOMAIN }}
      HA_API_Path: ${{ secrets.HA_API_Path }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üóÇÔ∏è List files for debugging
        run: ls -lR

      - name: üõ†Ô∏è Validate Secrets and Environment Variables
        run: |
          MISSING=false
          for var in AWS_ID AWS_KEY AWS_REGION LAMBDA_FUNCTION_NAME Python_Dependences HA_Token_1 HA_Token_2 HA_URL HA_API_Path; do
            if [ -z "${!var}" ]; then
              echo "::error::$var is missing or blank."
              MISSING=true
            else
              echo "$var is valid."
            fi
          done
          if [ "$MISSING" = true ]; then
            exit 1
          fi

      - name: üîë Configure AWS CLI
        run: |
          aws configure set aws_access_key_id $AWS_ID
          aws configure set aws_secret_access_key $AWS_KEY
          aws configure set default.region $AWS_REGION

      - name: üì¶ Install Dependencies and Prepare Package
        run: |
          mkdir -p package
          echo "${Python_Dependences}" | tr ',' '\n' > requirements.txt
          pip install -r requirements.txt -t ./package
          cp -r src/* package/

      - name: ‚òÅÔ∏è Deploy Lambda Function to AWS
        run: |
          set -e
          cd package
          zip -r ../lambda_deploy.zip .
          cd ..
          aws lambda update-function-code \
            --function-name $LAMBDA_FUNCTION_NAME \
            --zip-file fileb://lambda_deploy.zip \
            --region $AWS_REGION
